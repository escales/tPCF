#!/bin/bash

echo "üß™ Scanning for crash/staging failures using cf events..."

cf curl /v3/apps | jq -c '.resources[]' | while read -r app; do
    APP_GUID=$(echo "$app" | jq -r '.guid')
    APP_NAME=$(echo "$app" | jq -r '.name')
    SPACE_GUID=$(echo "$app" | jq -r '.relationships.space.data.guid')

    # Get org and space info
    SPACE_JSON=$(cf curl /v3/spaces/$SPACE_GUID)
    SPACE_NAME=$(echo "$SPACE_JSON" | jq -r '.name')
    ORG_GUID=$(echo "$SPACE_JSON" | jq -r '.relationships.organization.data.guid')
    ORG_NAME=$(cf curl /v3/organizations/$ORG_GUID | jq -r '.name')

    echo "üîé Checking: $APP_NAME ($ORG_NAME / $SPACE_NAME)"

    # Get recent events for the app (will show crash/staging failures)
    EVENTS=$(cf events "$APP_NAME" 2>/dev/null)

    if echo "$EVENTS" | grep -qi 'exit description\|no space left on device\|failed to create container'; then
        echo "‚ö†Ô∏è  App: $APP_NAME"
        echo "   Org/Space: $ORG_NAME / $SPACE_NAME"
        echo "   Events:"
        echo "$EVENTS" | grep -i 'exit description\|no space left on device\|failed to create container'
        echo ""
    else
        echo "‚úÖ No recent fatal events found for $APP_NAME"
        echo ""
    fi
done
